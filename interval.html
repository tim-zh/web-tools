<!DOCTYPE html>
<html lang="en">
<head>
  <title>interval</title>
  <style>
    * {
      font-size: 1.2em;
    }

    button {
      background: #5f5ff5;
      border: none;
      border-radius: 1em;
      color: #fff;
      margin: 1em;
      padding: 1em;
    }
  </style>
</head>
<body>
<script>
  let words = JSON.parse(localStorage.getItem("words")) || [] //todo no globals
  let wordsMetadata = JSON.parse(localStorage.getItem("words-metadata")) || {}

  function metadataKey(wordEntry) {
    return wordEntry[0] + "=" + wordEntry[1]
  }

  function getWordMetadata(wordEntry) {
    return wordsMetadata[metadataKey(wordEntry)] || {
      "lastUsed": new Date(2000, 0),
      "timesUsed": 0
    }
  }

  function compareWordsMetadata(a, b) {
    if (a.timesUsed === b.timesUsed)
      return a.lastUsed - b.lastUsed
    else
      return a.timesUsed - b.timesUsed
  }

  function updateMetadata(wordEntries) {
    let timestamp = Date.now()
    wordEntries.forEach(word => {
      wordsMetadata[metadataKey(word)] = {
        "lastUsed": timestamp,
        "timesUsed": (wordsMetadata[metadataKey(word)] || 0) + 1
      }
    })
    localStorage.setItem("words-metadata", JSON.stringify(wordsMetadata))
  }
</script>

<button id="configs-btn">configure</button>
<div id="configs-panel" style="display:none">
  <label>
    words in a lesson
    <input type="number" id="batch-size">
  </label>
  <label>
    enable exercise 1
    <input type="checkbox" id="enable-exercise1">
  </label>
  <label>
    enable exercise 2
    <input type="checkbox" id="enable-exercise2">
  </label>
  <label>
    enable exercise 3
    <input type="checkbox" id="enable-exercise3">
  </label>
  <button>save</button>
</div>
<script>
  let defaultConfigs = {
    batchSize: 30,
    enableExercise1: true,
    enableExercise2: true,
    enableExercise3: true,
    enableNotifications: false //todo
  }
  let loadedConfigs = JSON.parse(localStorage.getItem("configs"))
  let configs = {...defaultConfigs, ...loadedConfigs}
  document.querySelector("#configs-btn").onclick = () => {
    document.querySelector("#batch-size").value = configs.batchSize
    document.querySelector("#enable-exercise1").checked = configs.enableExercise1
    document.querySelector("#enable-exercise2").checked = configs.enableExercise2
    document.querySelector("#enable-exercise3").checked = configs.enableExercise3
    document.querySelector("#configs-panel").style.display = "block"
  }
  document.querySelector("#configs-panel > button").onclick = () => {
    configs.batchSize = document.querySelector("#batch-size").value
    configs.enableExercise1 = document.querySelector("#enable-exercise1").checked
    configs.enableExercise2 = document.querySelector("#enable-exercise2").checked
    configs.enableExercise3 = document.querySelector("#enable-exercise3").checked
    localStorage.setItem("configs", JSON.stringify(configs))
    document.querySelector("#configs-panel").style.display = "none"
  }
</script>

<button id="manage-words-btn">manage words</button>
<div id="manage-words-panel" style="display:none">
  <textarea></textarea>
  <button>save</button>
</div>
<script>
  document.querySelector("#manage-words-btn").onclick = () => {
    document.querySelector("#manage-words-panel > textarea").value = words.map(x => x.join("=")).join("\n")
    document.querySelector("#manage-words-panel").style.display = "block"
  }
  document.querySelector("#manage-words-panel > button").onclick = () => {
    words = document.querySelector("#manage-words-panel > textarea").value.split(/\n/).filter(x => !!x).map(str => str.split("=", 2))
    localStorage.setItem("words", JSON.stringify(words))
    document.querySelector("#manage-words-panel").style.display = "none"
    document.title = `total words: ${words.length}`
    setTimeout(() => document.title = "interval", 1000)
  }
</script>

<button>import</button> <!--todo-->
<button>export</button> <!--todo-->
<button id="start-btn">start a lesson</button>
<div id="lesson-panel" style="display:none"></div>
<script>

  function getLeastUsedWords(number) {
    return words.sort((a, b) => {
      compareWordsMetadata(getWordMetadata(a), getWordMetadata(b))
    }).slice(0, number)
  }

  function showLessonEnd(container) {
    container.innerHTML = document.querySelector(".lesson-end-panel").innerHTML
    container.querySelector("button").onclick = () => container.innerHTML = ""
  }

  function showExercise1(wordEntry, container, doneCallback) {
    container.innerHTML = document.querySelector(".exercise1-panel").innerHTML
    container.querySelector(".left-word").innerHTML = wordEntry[0]
    container.querySelector(".right-word").innerHTML = wordEntry[1]
    container.querySelector("button").onclick = doneCallback
  }

  function showExercise2(wordEntry, container, doneCallback) {
    container.innerHTML = document.querySelector(".exercise2-panel").innerHTML
    container.querySelector(".top-word").innerHTML = wordEntry[0]
    container.querySelector(".bottom-word").onclick = () => {
      container.querySelector(".bottom-word").innerHTML = wordEntry[1]
      container.querySelector(".bottom-word").active = false
      container.querySelector(".exercise2-next-btn").style.visibility = "visible"
    }
    container.querySelector(".exercise2-next-btn").onclick = doneCallback
  }

  function showExercise3(wordEntry, allWordEntries, container, doneCallback) {
    container.innerHTML = document.querySelector(".exercise3-panel").innerHTML
    let all = allWordEntries.filter(x => x !== wordEntry)
    function rngWord() {
      let result = all[Math.floor(Math.random() * all.length)] || ["", ""]
      all = all.filter(x => x !== result)
      return result
    }
    let rightOptionIndex = Math.floor(Math.random() * 4) + 1
    function fillOption(i) {
      let word = rightOptionIndex === i ? wordEntry : rngWord()
      let optionBtn = container.querySelector(`.option${i}-word`)
      optionBtn.innerHTML = word[1]
      optionBtn.onclick = () => {
        if (rightOptionIndex === i) {
          optionBtn.style.backgroundColor = "#5ff55f"
          setTimeout(doneCallback, 500)
        } else {
          optionBtn.style.backgroundColor = "#f55f5f"
          optionBtn.active = false
        }
      }
    }
    fillOption(1)
    fillOption(2)
    fillOption(3)
    fillOption(4)
    container.querySelector(".guess-word").innerHTML = wordEntry[0]
  }

  function showExerciseSeries(wordEntries, container, showExerciseCallback, doneCallback) {
    let nextCallback = doneCallback
    let i = wordEntries.length
    while (i > 0) {
      i -= 1
      let closureWords = wordEntries[i]
      let closureCallback = nextCallback
      nextCallback = () => showExerciseCallback(closureWords, container, closureCallback)
    }
    nextCallback()
  }

  function showCompoundExerciseSeries(wordEntries, container, showExerciseCallback, doneCallback) {
    showExerciseSeries(wordEntries, container, (a, b, c) => showExerciseCallback(a, wordEntries, b, c), doneCallback)
  }

  document.querySelector("#start-btn").onclick = () => {
    let lessonPanel = document.querySelector("#lesson-panel")
    let lessonWords = getLeastUsedWords(configs.batchSize)
    let doneCallback = () => showLessonEnd(lessonPanel)
    if (configs.enableExercise3) {
      let closureCallback = doneCallback
      doneCallback = () => showCompoundExerciseSeries(lessonWords, lessonPanel, showExercise3, closureCallback)
    }
    if (configs.enableExercise2) {
      let closureCallback = doneCallback
      doneCallback = () => showExerciseSeries(lessonWords, lessonPanel, showExercise2, closureCallback)
    }
    if (configs.enableExercise1) {
      let closureCallback = doneCallback
      doneCallback = () => showExerciseSeries(lessonWords, lessonPanel, showExercise1, closureCallback)
    }
    doneCallback()
    lessonPanel.style.display = "block"
  }
</script>

<div class="lesson-end-panel" style="display:none">
  <div>done</div>
  <button>close</button>
</div>

<div class="exercise1-panel" style="display:none">
  <div class="left-word"></div>
  <div class="right-word"></div>
  <button>next</button>
</div>

<div class="exercise2-panel" style="display:none">
  <div class="top-word"></div>
  <button class="bottom-word">show</button>
  <button class="exercise2-next-btn" style="visibility:hidden">next</button>
</div>

<div class="exercise3-panel" style="display:none">
  <div class="guess-word"></div>
  <button class="option1-word"></button>
  <button class="option2-word"></button>
  <button class="option3-word"></button>
  <button class="option4-word"></button>
</div>

</body>
</html>